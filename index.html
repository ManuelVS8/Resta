<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resta con Llevadas - Método Ascensor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f3e8ff 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            color: #7c3aed;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            text-align: center;
            color: #4b5563;
            margin-bottom: 1rem;
        }

        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #7c3aed;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 1000;
        }

        .sound-toggle:hover {
            background-color: #6d28d9;
            transform: scale(1.1);
        }

        .help-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto 2rem;
            transition: background-color 0.3s;
        }

        .help-button:hover {
            background-color: #2563eb;
        }

        .help-box {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #93c5fd;
            display: none;
        }

        .help-box.visible {
            display: block;
        }

        .help-box h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7c3aed;
            margin-bottom: 1rem;
        }

        .help-box ol {
            padding-left: 1.5rem;
            color: #374151;
        }

        .help-box li {
            margin-bottom: 0.5rem;
        }

        .game-box {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .operation-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .operation {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
        }

        .row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .digit-box {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .carry-mark {
            position: absolute;
            bottom: 0.25rem;
            left: 0.25rem;
            color: #ef4444;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .line {
            width: 4rem;
            border-top: 4px solid #1f2937;
        }

        .answer-box {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 2rem;
            font-weight: bold;
            background-color: #f9fafb;
            transition: all 0.3s;
        }

        .answer-box.current {
            border-color: #a855f7;
            background-color: #faf5ff;
            transform: scale(1.1);
        }

        .answer-box.filled {
            border-color: #4ade80;
            background-color: #f0fdf4;
            cursor: pointer;
        }

        .answer-box.filled:hover {
            background-color: #dcfce7;
        }

        .arrow-container {
            margin-left: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .arrow {
            width: 4rem;
            height: 4rem;
            color: #7c3aed;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .arrow-text {
            color: #7c3aed;
            font-weight: bold;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 0.5rem;
        }

        .question-box {
            background-color: #fef9c3;
            border: 2px solid #facc15;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            display: none;
        }

        .question-box.visible {
            display: block;
        }

        .question-box p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #854d0e;
            margin-bottom: 1rem;
        }

        .question-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .btn-yes {
            background-color: #22c55e;
            color: white;
        }

        .btn-yes:hover {
            background-color: #16a34a;
        }

        .btn-no {
            background-color: #ef4444;
            color: white;
        }

        .btn-no:hover {
            background-color: #dc2626;
        }

        .number-bank {
            margin-bottom: 1.5rem;
            display: none;
        }

        .number-bank.visible {
            display: block;
        }

        .number-bank p {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            max-width: 48rem;
            margin: 0 auto;
        }

        .number-btn {
            background-color: #a855f7;
            color: white;
            width: 4rem;
            height: 4rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .number-btn:hover {
            background-color: #9333ea;
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
            display: none;
        }

        .action-buttons.visible {
            display: flex;
        }

        .btn-check {
            background-color: #3b82f6;
            color: white;
        }

        .btn-check:hover {
            background-color: #2563eb;
        }

        .btn-next {
            background-color: #22c55e;
            color: white;
        }

        .btn-next:hover {
            background-color: #16a34a;
        }

        .feedback {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
        }

        .feedback.visible {
            display: block;
        }

        .feedback.success {
            background-color: #dcfce7;
            color: #166534;
        }

        .feedback.error {
            background-color: #fed7aa;
            color: #9a3412;
        }

        .manual-button {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            transition: background-color 0.3s;
        }

        .manual-button:hover {
            background-color: #4f46e5;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <button id="soundToggle" class="sound-toggle">🔊</button>
    
    <div class="container">
        <h1>🧮 Resta con Llevadas - Método Ascensor</h1>
        <p class="subtitle">Como un ascensor: si no puedes restar, ¡sube una planta! (suma 10)</p>
        
        <div class="text-center">
            <button class="help-button" onclick="toggleHelp()">
                <span>❓</span>
                <span id="helpButtonText">Mostrar ayuda</span>
            </button>
        </div>

        <div id="helpBox" class="help-box">
            <h2>📚 Cómo jugar:</h2>
            <ol>
                <li>Empieza por la columna de las unidades (derecha)</li>
                <li>Si no puedes restar porque el número de arriba es menor, "sube en el ascensor" (suma 10)</li>
                <li>Haz clic en el número correcto del banco de números</li>
                <li>Responde si te llevas 1 para la siguiente columna (aparecerá un 1 pequeño delante)</li>
                <li>Si te llevas 1, recuerda sumarlo a la cifra del sustraendo en la siguiente columna</li>
                <li>Continúa hasta completar toda la resta</li>
                <li>¡Comprueba tu respuesta al final!</li>
            </ol>
        </div>

        <div class="game-box">
            <div class="operation-container">
                <div class="operation">
                    <div id="minuendRow" class="row"></div>
                    <div id="subtrahendRow" class="row"></div>
                    <div id="lineRow" class="row"></div>
                    <div id="answerRow" class="row"></div>
                </div>
                <div class="arrow-container">
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                    <p class="arrow-text">Sube el<br/>ascensor</p>
                </div>
            </div>

            <div id="questionBox" class="question-box">
                <p>¿Te llevas 1 para la siguiente columna?</p>
                <div class="question-buttons">
                    <button class="btn btn-yes" onclick="handleCarry(true)">Sí, me llevo 1</button>
                    <button class="btn btn-no" onclick="handleCarry(false)">No, continúo</button>
                </div>
            </div>

            <div id="numberBank" class="number-bank">
                <p>Banco de números (haz clic para colocar):</p>
                <div class="numbers" id="numbers"></div>
            </div>

            <div id="actionButtons" class="action-buttons">
                <button id="checkButton" class="btn btn-check" onclick="checkAnswer()">
                    <span>✓</span> Comprobar
                </button>
                <button id="nextButton" class="btn btn-next" onclick="generateNewOperation()">
                    <span>→</span> Siguiente
                </button>
                </div>

            <div id="feedback" class="feedback"></div>
        </div>

        <div class="text-center">
            <button class="manual-button" onclick="changeOperation()">Cambiar operación manualmente</button>
        </div>
    </div>

    <script>
        // REQUISITO: Restas siempre de 5 cifras
        const DIGITS = 5;
        var minuend = '';
        var subtrahend = '';
        var userAnswer = {};
        var carries = {};
        var currentColumn = 0;
        var showCarryQuestion = false;
        var gameStarted = false;
        var isChecked = false;
        var soundEnabled = true;
        var audioInitialized = false;

        // Crear elementos de audio
        var audioCorrecto = new Audio('https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Correcto.mp3');
        var audioError = new Audio('https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3');
        var audioTap = new Audio('https://github.com/ManuelVS8/Efectos_audio/raw/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3');

        // Funciones de sonido
        function reproducirSonidoCorrecto() {
            if (soundEnabled && audioInitialized) {
                audioCorrecto.currentTime = 0;
                audioCorrecto.play().catch(e => console.error("Error al reproducir sonido correcto:", e));
            }
        }

        function reproducirSonidoError() {
            if (soundEnabled && audioInitialized) {
                audioError.currentTime = 0;
                audioError.play().catch(e => console.error("Error al reproducir sonido de error:", e));
            }
        }

        function reproducirSonidoTap() {
            if (soundEnabled && audioInitialized) {
                audioTap.currentTime = 0;
                audioTap.play().catch(e => console.error("Error al reproducir sonido tap:", e));
            }
        }

        // Función para inicializar audio en el primer clic del usuario
        function initAudio() {
            if (!audioInitialized) {
                // Crear un contexto de audio para desbloquear la reproducción
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.resume();
                
                // Cargar los audios
                audioCorrecto.load();
                audioError.load();
                audioTap.load();
                
                audioInitialized = true;
            }
        }

        // Función para alternar el sonido
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? '🔊' : '🔇';
            reproducirSonidoTap();
        }

        // Añadir evento de clic al botón de sonido
        document.getElementById('soundToggle').addEventListener('click', toggleSound);

        function generateRandomNumber(digits) {
            var min = Math.pow(10, digits - 1);
            var max = Math.pow(10, digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateOperationWithCarries() {
            var num1, num2;
            var hasCarry = false;
            var attempts = 0;

            // Bucle para asegurar 5 cifras Y al menos una "llevada"
            while (!hasCarry && attempts < 100) {
                num1 = generateRandomNumber(DIGITS); // 5 cifras
                num2 = generateRandomNumber(DIGITS); // 5 cifras

                // Asegurar minuendo > sustraendo
                if (num1 < num2) {
                    var temp = num1;
                    num1 = num2;
                    num2 = temp;
                }

                var mStr = num1.toString();
                var sStr = num2.toString().padStart(DIGITS, '0');

                hasCarry = false;
                var currentCarry = 0;

                // Verificar llevadas de derecha a izquierda
                for (var i = DIGITS - 1; i >= 0; i--) {
                    var mDigit = parseInt(mStr[i]);
                    var sDigit = parseInt(sStr[i]) + currentCarry;
                    
                    if (mDigit < sDigit) {
                        hasCarry = true;
                        currentCarry = 1; 
                    } else {
                        currentCarry = 0;
                    }
                }
                attempts++;
            }

            minuend = num1.toString();
            subtrahend = num2.toString();

            // Opción de reserva
            if (!hasCarry) {
                minuend = '65432';
                subtrahend = '18765';
            }
        }

        function generateNewOperation() {
            generateOperationWithCarries();
            reset();
        }

        function init() {
            generateNewOperation(); 
            renderNumberBank();
        }

        function toggleHelp() {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            var helpBox = document.getElementById('helpBox');
            var buttonText = document.getElementById('helpButtonText');
            helpBox.classList.toggle('visible');
            buttonText.textContent = helpBox.classList.contains('visible') ? 'Ocultar ayuda' : 'Mostrar ayuda';
        }

        function renderOperation() {
            var numDigits = DIGITS; // Fijo a 5
            
            var minuendRow = document.getElementById('minuendRow');
            minuendRow.innerHTML = '';
            var paddedMinuend = minuend.padStart(numDigits, '0');
            for (var i = 0; i < numDigits; i++) {
                var div = document.createElement('div');
                div.className = 'digit-box';
                div.textContent = paddedMinuend[i];
                minuendRow.appendChild(div);
            }

            var subtrahendRow = document.getElementById('subtrahendRow');
            subtrahendRow.innerHTML = '<div class="digit-box">−</div>';
            var paddedSubtrahend = subtrahend.padStart(numDigits, '0');
            for (var i = 0; i < numDigits; i++) {
                var div = document.createElement('div');
                div.className = 'digit-box';
                div.id = 'sub-' + i;
                div.textContent = paddedSubtrahend[i];
                
                var reverseIdx = numDigits - 1 - i; 
                
                if (carries[reverseIdx]) { 
                    var carry = document.createElement('span');
                    carry.className = 'carry-mark';
                    carry.textContent = '1';
                    div.appendChild(carry);
                }
                
                subtrahendRow.appendChild(div);
            }

            var lineRow = document.getElementById('lineRow');
            lineRow.innerHTML = '<div class="digit-box"></div>';
            for (var i = 0; i < numDigits; i++) {
                var div = document.createElement('div');
                div.className = 'line';
                lineRow.appendChild(div);
            }

            var answerRow = document.getElementById('answerRow');
            answerRow.innerHTML = '<div class="digit-box"></div>';
            for (var i = 0; i < numDigits; i++) {
                var reverseIdx = numDigits - 1 - i; // Índice de columna: 0 (unidades), 1 (decenas)...
                var div = document.createElement('div');
                div.className = 'answer-box';
                div.id = 'ans-' + i; // i es el índice de renderizado (0=izquierda)
                
                if (currentColumn === reverseIdx && gameStarted && !isChecked) {
                    div.classList.add('current');
                }
                
                if (userAnswer[reverseIdx] !== undefined) {
                    div.textContent = userAnswer[reverseIdx];
                    div.classList.add('filled');
                    if (!isChecked) { 
                        div.onclick = (function(idx) {
                            return function() {
                                deleteAnswer(idx);
                            };
                        })(reverseIdx);
                    }
                }
                
                answerRow.appendChild(div);
            }

            updateUI();
        }

        function renderNumberBank() {
            var numbers = document.getElementById('numbers');
            numbers.innerHTML = '';
            for (var i = 0; i <= 9; i++) {
                var btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i;
                btn.onclick = (function(num) {
                    return function() {
                        handleNumberClick(num);
                    };
                })(i);
                numbers.appendChild(btn);
            }
        }

        function handleNumberClick(num) {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            if (!gameStarted) {
                gameStarted = true;
            }
            
            var numDigits = DIGITS;
            if (currentColumn >= numDigits) return; 

            document.getElementById('feedback').classList.remove('visible');
            
            userAnswer[currentColumn] = num;
            
            if (currentColumn < numDigits - 1) {
                showCarryQuestion = true;
            } else {
                currentColumn++;
            }
            
            renderOperation();
        }

        function handleCarry(hasCarry) {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            
            if (hasCarry) {
                var nextColumn = currentColumn + 1;
                carries[nextColumn] = true;
            } else {
                delete carries[currentColumn + 1];
            }
            
            showCarryQuestion = false;
            currentColumn++;
            
            renderOperation();
        }

        function deleteAnswer(idx) {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            
            delete userAnswer[idx];
            delete carries[idx + 1];
            currentColumn = idx;
            showCarryQuestion = false;
            isChecked = false; // Permitir al usuario corregir después de un chequeo fallido
            document.getElementById('feedback').classList.remove('visible');
            renderOperation();
        }

        function checkAnswer() {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            var numDigits = DIGITS;
            var correctAnswerNum = parseInt(minuend) - parseInt(subtrahend);
            var correctAnswer = correctAnswerNum.toString().padStart(numDigits, '0');
            
            // CORRECCIÓN: Reconstruir la respuesta del usuario correctamente
            var userResult = '';
            for (let i = 0; i < numDigits; i++) {
                var columnIdx = numDigits - 1 - i; // Convertir de posición de visualización a índice de columna
                if (userAnswer[columnIdx] === undefined) {
                    document.getElementById('feedback').textContent = 'Asegúrate de completar todos los dígitos antes de comprobar.';
                    document.getElementById('feedback').className = 'feedback error visible';
                    isChecked = false;
                    updateUI();
                    return;
                }
                userResult += userAnswer[columnIdx];
            }
            
            userResult = userResult.padStart(numDigits, '0'); 
            
            var feedback = document.getElementById('feedback');

            if (userResult === correctAnswer) {
                feedback.textContent = '¡Excelente! La respuesta es correcta. 🎉';
                feedback.className = 'feedback success visible';
                reproducirSonidoCorrecto();
            } else {
                var displayCorrectAnswer = correctAnswerNum.toString();
                feedback.innerHTML = `Ups, revisa tu respuesta. La respuesta correcta es: <strong>${displayCorrectAnswer}</strong>.`;
                feedback.className = 'feedback error visible';
                reproducirSonidoError();
            }
            
            isChecked = true;
            renderOperation(); 
            updateUI();
        }

        function reset() {
            userAnswer = {};
            carries = {};
            currentColumn = 0;
            showCarryQuestion = false;
            gameStarted = false;
            isChecked = false;
            document.getElementById('feedback').classList.remove('visible');
            renderOperation();
        }

        function changeOperation() {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            
            var newMinuend = prompt('Introduce el minuendo (5 cifras):', minuend);
            var newSubtrahend = prompt('Introduce el sustraendo (5 cifras):', subtrahend);
            
            if (newMinuend && newSubtrahend && 
                newMinuend.length === DIGITS && newSubtrahend.length === DIGITS &&
                parseInt(newMinuend) > parseInt(newSubtrahend)) {
                
                minuend = newMinuend;
                subtrahend = newSubtrahend;
                reset();
            } else if (newMinuend && newSubtrahend) {
                 alert('Error: Ambos números deben ser de 5 cifras y el minuendo debe ser mayor que el sustraendo.');
            }
        }

        function updateUI() {
            var numDigits = DIGITS;
            var questionBox = document.getElementById('questionBox');
            var numberBank = document.getElementById('numberBank');
            var actionButtons = document.getElementById('actionButtons');
            var checkButton = document.getElementById('checkButton');
            var nextButton = document.getElementById('nextButton');
            
            if (showCarryQuestion && !isChecked) {
                questionBox.classList.add('visible');
            } else {
                questionBox.classList.remove('visible');
            }
            
            if (!showCarryQuestion && currentColumn < numDigits && !isChecked) {
                numberBank.classList.add('visible');
            } else {
                numberBank.classList.remove('visible');
            }
            
            if (currentColumn >= numDigits && !showCarryQuestion) {
                actionButtons.classList.add('visible');
            } else {
                actionButtons.classList.remove('visible');
            }
            
            // Lógica de botones: solo se muestra "Siguiente" después de comprobar
            if (isChecked) {
                checkButton.style.display = 'none';
                nextButton.style.display = 'flex'; 
            } else {
                checkButton.style.display = 'flex';
                nextButton.style.display = 'none';
            }
        }

        init();
    </script>
</body>
</html>
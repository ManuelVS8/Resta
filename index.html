<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resta con Llevadas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para personalización */
        :root {
            --primary: #3b82f6;
            --secondary: #ff9f43;
            --success: #10b981;
            --danger: #ef4444;
            --bg-start: #1a3a5f;
            --bg-end: #0d2340;
            --card-bg: #FFFFFF;
            --text-dark: #1e3a8a;
            --text-medium: #334155;
            --text-light: #6b7280;
            --hint-bg: #e0effc;
            --confetti-colors: #d946ef, #ff9f43, #3b82f6, #10b981, #facc15;
            --shadow: 0px 8px 24px rgba(0, 0, 0, 0.1);
            --transition: 180ms ease;
            --final-score-color: #0055e0;
            --container-max-width: 1200px;
        }

        /* Estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, var(--bg-start), var(--bg-end));
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        /* Contenedor principal */
        .container {
            width: 100%;
            max-width: var(--container-max-width);
            background-color: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        /* Tipografía */
        h1, h2, h3 {
            margin-bottom: 16px;
            color: var(--text-dark);
            font-weight: 700;
        }

        h1 {
            font-size: 2.5em;
            text-align: center;
        }

        h2 {
            font-size: 1.8em;
        }

        h3 {
            font-size: 1.4em;
        }

        p {
            margin-bottom: 16px;
            color: var(--text-light);
        }

        /* Botones */
        .btn {
            display: inline-block;
            padding: 15px 40px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition);
            text-align: center;
            text-decoration: none;
            min-height: 44px;
            min-width: 44px;
            position: relative;
            z-index: 10;
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            filter: brightness(1.1);
        }

        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 50%;
            background-color: transparent;
            color: var(--text-dark);
            position: relative;
            z-index: 10;
        }

        .btn-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            position: relative;
            z-index: 10;
        }

        .btn-group-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 10px;
            position: relative;
            z-index: 10;
        }

        /* Pantallas */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 5;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Pantalla de inicio */
        .start-screen {
            text-align: center;
        }

        .start-screen h1 {
            margin-bottom: 24px;
        }

        .start-screen p {
            max-width: 600px;
            margin: 0 auto 24px;
            font-size: 1.2em;
            color: var(--text-light);
        }

        .hint-card {
            background-color: var(--hint-bg);
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 650px;
            color: var(--text-medium);
            font-size: 1.1em;
        }

        .hint-card span {
            font-weight: 700;
            color: var(--secondary);
        }

        .start-image {
            max-width: 100%;
            margin: 20px auto;
            display: block;
            border-radius: 12px;
        }

        /* Barra de progreso */
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 24px;
            overflow: hidden;
            position: relative;
            z-index: 5;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--secondary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: right;
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        /* Controles superiores */
        .top-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 20;
        }

        .timer {
            background-color: var(--card-bg);
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            font-weight: 600;
            font-size: 14px;
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 20;
        }

        .top-buttons {
            display: flex;
            gap: 8px;
        }

        /* Números y bloques */
        .number-container {
            margin: 20px 0;
            text-align: center;
            position: relative;
            z-index: 5;
        }

        .number-display {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 24px;
            letter-spacing: 1px;
            padding: 10px 20px;
            background-color: rgba(59, 130, 246, 0.05);
            border-radius: 10px;
            display: inline-block;
        }

        .instruction-text {
            font-style: italic;
            color: var(--text-medium);
            margin: 10px 0 20px;
            font-size: 1.1em;
        }

        .digit-blocks {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-bottom: 30px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 10px 0;
            max-width: 100%;
            position: relative;
            z-index: 5;
        }

        .digit-block {
            width: 48px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border-radius: 10px;
            font-size: 24px;
            font-weight: 600;
            position: relative;
            transition: all var(--transition);
            flex-shrink: 0;
            cursor: pointer;
            z-index: 5;
        }

        .digit-block.editable {
            background-color: white;
            border: 2px dashed #ccc;
        }

        .digit-block.editable.filled {
            background-color: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
        }

        .digit-block.editable.error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            animation: shake 0.5s ease;
        }

        .digit-separator {
            width: 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
            flex-shrink: 0;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Banco de dígitos */
        .digit-bank {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin: 20px auto;
            position: relative;
            z-index: 5;
            width: 100%;
            max-width: 800px;
        }

        .digit-btn {
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            position: relative;
            z-index: 10;
        }

        .digit-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .digit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .digit-btn:disabled:hover {
            background-color: var(--card-bg);
            color: var(--text-dark);
            border-color: #e0e0e0;
            transform: none;
        }

        /* Estilo para el botón "Completar con ceros" similar a los dígitos del banco */
        .fill-zeros-btn {
            width: auto;
            height: 54px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-dark);
            position: relative;
            z-index: 10;
        }

        .fill-zeros-btn:hover {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Feedback */
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
            animation: fadeIn 0.3s ease;
            position: relative;
            z-index: 5;
            font-size: 1.1em;
        }

        .feedback.success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .feedback.error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .feedback.show {
            display: block;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform var(--transition);
            position: relative;
            z-index: 1001;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            transition: color var(--transition);
            position: relative;
            z-index: 10;
        }

        .modal-close:hover {
            color: var(--text-dark);
        }

        /* Estilos para el contenido del modal de ayuda */
        .help-content h3 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 1.3em;
        }

        .help-steps {
            margin-bottom: 24px;
        }

        .help-steps ol {
            margin-left: 24px;
            margin-bottom: 16px;
        }

        .help-steps li {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .help-rule {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--primary);
            padding: 16px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .rule-item:last-child {
            margin-bottom: 0;
        }

        .rule-arrow {
            color: var(--primary);
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .rule-text {
            flex: 1;
            font-size: 1.1em;
        }

        .rule-highlight {
            color: var(--primary);
            font-weight: 600;
        }

        .help-examples {
            margin-top: 30px;
        }

        .example {
            background-color: rgba(255, 159, 67, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .example:last-child {
            margin-bottom: 0;
        }

        .example-title {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .example-step {
            margin-bottom: 10px;
            padding-left: 24px;
            position: relative;
            font-size: 1.1em;
        }

        .example-step:before {
            content: "•";
            position: absolute;
            left: 10px;
            color: var(--secondary);
        }

        .example-result {
            font-weight: 600;
            margin-top: 12px;
            font-size: 1.2em;
        }

        .example-explanation {
            font-style: italic;
            color: var(--text-light);
            margin-top: 12px;
            font-size: 1.1em;
        }

        /* Pantalla final */
        .final-screen {
            text-align: center;
        }

        .trophy {
            font-size: 80px;
            margin: 20px 0;
            animation: trophyAnimation 2s ease-in-out infinite;
            display: none;
        }

        .trophy.show {
            display: block;
        }

        @keyframes trophyAnimation {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            50% { transform: scale(1.2) rotate(5deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
        }

        .final-score {
            font-size: 3.5em;
            font-weight: 700;
            color: var(--final-score-color) !important;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .final-score.perfect {
            color: var(--final-score-color) !important;
        }

        .final-time {
            font-size: 20px;
            color: var(--text-light);
            margin-bottom: 24px;
        }

        .final-message {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 24px;
        }

        .credit {
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-light);
        }

        .school-logo {
            max-width: 150px;
            margin: 20px auto;
            display: block;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary);
            position: absolute;
            animation: confetti-fall 3s linear forwards;
            z-index: 999;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Puntuación en modo infinito */
        .infinite-score {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            font-weight: 600;
            font-size: 16px;
            z-index: 20;
        }

        /* Resaltado de magnitud en el título */
        .magnitude-highlight {
            color: #ff9f43;
            font-weight: 700;
        }

        /* Responsive */
        @media (min-width: 480px) {
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 2.8em;
            }
            
            .number-display {
                font-size: 40px;
                padding: 12px 24px;
            }
            
            .digit-block {
                width: 54px;
                height: 68px;
                font-size: 26px;
            }
            
            .digit-separator {
                height: 68px;
                font-size: 30px;
            }
            
            .digit-btn {
                width: 60px;
                height: 60px;
                font-size: 26px;
            }
            
            .trophy {
                font-size: 100px;
            }
        }
        
        @media (min-width: 768px) {
            h1 {
                font-size: 3.2em;
            }
            
            .number-display {
                font-size: 44px;
                padding: 14px 28px;
            }
            
            .digit-block {
                width: 60px;
                height: 75px;
                font-size: 28px;
            }
            
            .digit-separator {
                height: 75px;
                font-size: 32px;
            }
            
            .digit-btn {
                width: 66px;
                height: 66px;
                font-size: 28px;
            }
            
            .top-controls {
                top: 20px;
                left: 20px;
            }
            
            .timer {
                top: 20px;
                right: 20px;
                padding: 10px 18px;
                font-size: 16px;
            }
            
            .trophy {
                font-size: 120px;
            }
            
            /* Para pantallas más grandes, el banco de dígitos en una sola fila */
            .digit-bank {
                max-width: 800px;
                flex-wrap: nowrap;
            }
        }

        /* Para pantallas muy pequeñas, organizar el banco de dígitos en dos filas */
        @media (max-width: 767px) {
            .digit-bank {
                max-width: 300px;
                flex-wrap: wrap;
            }
            
            .digit-btn {
                width: 48px;
                height: 48px;
                font-size: 22px;
            }
            
            .digit-block {
                width: 42px;
                height: 54px;
                font-size: 22px;
            }
            
            .digit-separator {
                height: 54px;
                font-size: 26px;
            }
            
            .number-display {
                font-size: 32px;
                padding: 8px 16px;
            }
            
            .fill-zeros-btn {
                height: 48px;
                font-size: 16px;
                padding: 0 14px;
            }
        }

        /* Accesibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Animaciones reducidas */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .trophy {
                animation: none;
            }
        }

        /* Estilos específicos para la aplicación de resta */
        .operation-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 5;
        }

        .operation {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-family: 'Courier New', monospace;
            font-size: 2.5rem;
        }

        .row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .digit-box {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .carry-mark {
            position: absolute;
            bottom: 0.25rem;
            left: 0.25rem;
            color: #ef4444;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .line {
            width: 4rem;
            border-top: 4px solid #1f2937;
        }

        .answer-box {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 2rem;
            font-weight: bold;
            background-color: #f9fafb;
            transition: all 0.3s;
        }

        .answer-box.current {
            border-color: #a855f7;
            background-color: #faf5ff;
            transform: scale(1.1);
        }

        .answer-box.filled {
            border-color: #4ade80;
            background-color: #f0fdf4;
            cursor: pointer;
        }

        .answer-box.filled:hover {
            background-color: #dcfce7;
        }

        .arrow-container {
            margin-left: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .arrow {
            width: 4rem;
            height: 4rem;
            color: #7c3aed;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .arrow-text {
            color: #7c3aed;
            font-weight: bold;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 0.5rem;
        }

        .question-box {
            background-color: #fef9c3;
            border: 2px solid #facc15;
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
            display: none;
        }

        .question-box.visible {
            display: block;
        }

        .question-box p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #854d0e;
            margin-bottom: 1rem;
        }

        .question-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-yes {
            background-color: #22c55e;
            color: white;
        }

        .btn-yes:hover {
            background-color: #16a34a;
        }

        .btn-no {
            background-color: #ef4444;
            color: white;
        }

        .btn-no:hover {
            background-color: #dc2626;
        }

        .number-bank {
            margin-bottom: 1.5rem;
            display: none;
        }

        .number-bank.visible {
            display: block;
        }

        .number-bank p {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            max-width: 48rem;
            margin: 0 auto;
        }

        /* CORRECCIÓN: Paleta de colores para los botones del banco de números */
        .number-btn {
            background-color: var(--card-bg); /* Fondo blanco */
            color: var(--text-dark); /* Texto azul oscuro */
            border: 2px solid #e0e0e0; /* Borde gris */
            width: 4rem;
            height: 4rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .number-btn:hover {
            background-color: var(--primary); /* Fondo azul al pasar el ratón */
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
            display: none;
        }

        .action-buttons.visible {
            display: flex;
        }

        .btn-check {
            background-color: #3b82f6;
            color: white;
        }

        .btn-check:hover {
            background-color: #2563eb;
        }

        .btn-next {
            background-color: #22c55e;
            color: white;
        }

        .btn-next:hover {
            background-color: #16a34a;
        }

        .manual-button {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            transition: background-color 0.3s;
        }

        .manual-button:hover {
            background-color: #4f46e5;
        }

        .text-center {
            text-align: center;
        }

        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #7c3aed;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
            z-index: 1000;
        }

        .sound-toggle:hover {
            background-color: #6d28d9;
            transform: scale(1.1);
        }

        .help-button {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto 2rem;
            transition: background-color 0.3s;
        }

        .help-button:hover {
            background-color: #2563eb;
        }

        .help-box {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 2px solid #93c5fd;
            display: none;
        }

        .help-box.visible {
            display: block;
        }

        .help-box h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #7c3aed;
            margin-bottom: 1rem;
        }

        .help-box ol {
            padding-left: 1.5rem;
            color: #374151;
        }

        .help-box li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <button id="soundToggle" class="sound-toggle">🔊</button>
    
    <div class="container">
        <h1>🧮 Resta con Llevadas</h1>
        <center><p class="subtitle">Como un ascensor: si no puedes restar, ¡sube una planta!</p></center>
        
        
        <div class="text-center">
            <button class="help-button" onclick="toggleHelp()">
                <span>❓</span>
                <span id="helpButtonText">Mostrar ayuda</span>
            </button>
        </div>

        <div id="helpBox" class="help-box">
            <h2>📚 Pasos para realizar la resta con llevadas:</h2>
            <ol>
                <li>Empieza por la derecha.</li>
                <li>Busca cuánto falta para llegar a la cifra de arriba.</li>
                <li>Si completas hasta una decena mayor (ej. de 7 a 13), te llevas 1.</li>
                <li>Esa llevada se suma a la siguiente cifra del sustraendo.</li>
            </ol>
            
            <p style="margin-top: 1rem; margin-bottom: 1rem;"></p>
            
            <p style="font-weight: bold; text-align: center;">¡Comprueba tu respuesta al final!</p>
        </div>

        <div class="game-box">
            <div class="operation-container">
                <div class="operation">
                    <div id="minuendRow" class="row"></div>
                    <div id="subtrahendRow" class="row"></div>
                    <div id="lineRow" class="row"></div>
                    <div id="answerRow" class="row"></div>
                </div>
                <div class="arrow-container">
                    <svg class="arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                    <p class="arrow-text">Sube el<br/>ascensor</p>
                </div>
            </div>

            <div id="questionBox" class="question-box">
                <p>¿Te llevas 1 para la siguiente columna?</p>
                <div class="question-buttons">
                    <button class="btn btn-yes" onclick="handleCarry(true)">Sí, me llevo 1</button>
                    <button class="btn btn-no" onclick="handleCarry(false)">No, continúo</button>
                </div>
            </div>

            <div id="numberBank" class="number-bank">
                <p>Banco de números (haz clic para colocar):</p>
                <div class="numbers" id="numbers"></div>
            </div>

            <div id="actionButtons" class="action-buttons">
                <button id="checkButton" class="btn btn-check" onclick="checkAnswer()">
                    <span>✓</span> Comprobar
                </button>
                <button id="nextButton" class="btn btn-next" onclick="generateNewOperation()">
                    <span>→</span> Siguiente
                </button>
            </div>

            <div id="feedback" class="feedback"></div>
        </div>

        <div class="text-center">
            <button class="manual-button" onclick="changeOperation()">Cambiar operación manualmente</button>
        </div>
    </div>

    <script>
        // Variables globales
        var minuend = '';
        var subtrahend = '';
        var userAnswer = {};
        var carries = {};
        var currentColumn = 0;
        var showCarryQuestion = false;
        var gameStarted = false;
        var isChecked = false;
        var soundEnabled = true;
        var audioInitialized = false;
        var maxDigits = 5; // Por defecto, máximo de dígitos

        // Crear elementos de audio
        var audioCorrecto = new Audio('https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Correcto.mp3');
        var audioError = new Audio('https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3');
        var audioTap = new Audio('https://github.com/ManuelVS8/Efectos_audio/raw/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3');

        // Funciones de sonido
        function reproducirSonidoCorrecto() {
            if (soundEnabled && audioInitialized) {
                audioCorrecto.currentTime = 0;
                audioCorrecto.play().catch(e => console.error("Error al reproducir sonido correcto:", e));
            }
        }

        function reproducirSonidoError() {
            if (soundEnabled && audioInitialized) {
                audioError.currentTime = 0;
                audioError.play().catch(e => console.error("Error al reproducir sonido de error:", e));
            }
        }

        function reproducirSonidoTap() {
            if (soundEnabled && audioInitialized) {
                audioTap.currentTime = 0;
                audioTap.play().catch(e => console.error("Error al reproducir sonido tap:", e));
            }
        }

        // Función para inicializar audio en el primer clic del usuario
        function initAudio() {
            if (!audioInitialized) {
                // Crear un contexto de audio para desbloquear la reproducción
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioContext.resume();
                
                // Cargar los audios
                audioCorrecto.load();
                audioError.load();
                audioTap.load();
                
                audioInitialized = true;
            }
        }

        // Función para alternar el sonido
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? '🔊' : '🔇';
            reproducirSonidoTap();
        }

        // Añadir evento de clic al botón de sonido
        document.getElementById('soundToggle').addEventListener('click', toggleSound);

        function generateRandomNumber(digits) {
            var min = Math.pow(10, digits - 1);
            var max = Math.pow(10, digits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateOperationWithCarries() {
            var num1, num2;
            var hasCarry = false;
            var attempts = 0;

            // Bucle para asegurar al menos una "llevada"
            while (!hasCarry && attempts < 100) {
                num1 = generateRandomNumber(maxDigits);
                num2 = generateRandomNumber(maxDigits);

                // Asegurar minuendo > sustraendo
                if (num1 < num2) {
                    var temp = num1;
                    num1 = num2;
                    num2 = temp;
                }

                var mStr = num1.toString();
                var sStr = num2.toString().padStart(maxDigits, '0');

                hasCarry = false;
                var currentCarry = 0;

                // Verificar llevadas de derecha a izquierda
                for (var i = maxDigits - 1; i >= 0; i--) {
                    var mDigit = parseInt(mStr[i]);
                    var sDigit = parseInt(sStr[i]) + currentCarry;
                    
                    if (mDigit < sDigit) {
                        hasCarry = true;
                        currentCarry = 1; 
                    } else {
                        currentCarry = 0;
                    }
                }
                attempts++;
            }

            minuend = num1.toString();
            subtrahend = num2.toString();

            // Opción de reserva
            if (!hasCarry) {
                minuend = '65432';
                subtrahend = '18765';
            }
        }

        function generateNewOperation() {
            generateOperationWithCarries();
            reset();
        }

        function init() {
            generateNewOperation(); 
            renderNumberBank();
        }

        function toggleHelp() {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            var helpBox = document.getElementById('helpBox');
            var buttonText = document.getElementById('helpButtonText');
            helpBox.classList.toggle('visible');
            buttonText.textContent = helpBox.classList.contains('visible') ? 'Ocultar ayuda' : 'Mostrar ayuda';
        }

        function renderOperation() {
            var numDigits = Math.max(minuend.length, subtrahend.length);
            
            var minuendRow = document.getElementById('minuendRow');
            minuendRow.innerHTML = '';
            var paddedMinuend = minuend.padStart(numDigits, '0');
            for (var i = 0; i < numDigits; i++) {
                var div = document.createElement('div');
                div.className = 'digit-box';
                div.textContent = paddedMinuend[i];
                minuendRow.appendChild(div);
            }

            var subtrahendRow = document.getElementById('subtrahendRow');
            subtrahendRow.innerHTML = '<div class="digit-box">−</div>';
            var paddedSubtrahend = subtrahend.padStart(numDigits, '0');
            for (var i = 0; i < numDigits; i++) {
                var div = document.createElement('div');
                div.className = 'digit-box';
                div.id = 'sub-' + i;
                div.textContent = paddedSubtrahend[i];
                
                var reverseIdx = numDigits - 1 - i; 
                
                if (carries[reverseIdx]) { 
                    var carry = document.createElement('span');
                    carry.className = 'carry-mark';
                    carry.textContent = '1';
                    div.appendChild(carry);
                }
                
                subtrahendRow.appendChild(div);
            }

            var lineRow = document.getElementById('lineRow');
            lineRow.innerHTML = '<div class="digit-box"></div>';
            for (var i = 0; i < numDigits; i++) {
                var div = document.createElement('div');
                div.className = 'line';
                lineRow.appendChild(div);
            }

            var answerRow = document.getElementById('answerRow');
            answerRow.innerHTML = '<div class="digit-box"></div>';
            for (var i = 0; i < numDigits; i++) {
                var reverseIdx = numDigits - 1 - i; // Índice de columna: 0 (unidades), 1 (decenas)...
                var div = document.createElement('div');
                div.className = 'answer-box';
                div.id = 'ans-' + i; // i es el índice de renderizado (0=izquierda)
                
                if (currentColumn === reverseIdx && gameStarted && !isChecked) {
                    div.classList.add('current');
                }
                
                if (userAnswer[reverseIdx] !== undefined) {
                    div.textContent = userAnswer[reverseIdx];
                    div.classList.add('filled');
                    if (!isChecked) { 
                        div.onclick = (function(idx) {
                            return function() {
                                deleteAnswer(idx);
                            };
                        })(reverseIdx);
                    }
                }
                
                answerRow.appendChild(div);
            }

            updateUI();
        }

        function renderNumberBank() {
            var numbers = document.getElementById('numbers');
            numbers.innerHTML = '';
            for (var i = 0; i <= 9; i++) {
                var btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i;
                btn.onclick = (function(num) {
                    return function() {
                        handleNumberClick(num);
                    };
                })(i);
                numbers.appendChild(btn);
            }
        }

        function handleNumberClick(num) {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            if (!gameStarted) {
                gameStarted = true;
            }
            
            var numDigits = Math.max(minuend.length, subtrahend.length);
            if (currentColumn >= numDigits) return; 

            document.getElementById('feedback').classList.remove('visible');
            
            userAnswer[currentColumn] = num;
            
            if (currentColumn < numDigits - 1) {
                showCarryQuestion = true;
            } else {
                currentColumn++;
            }
            
            renderOperation();
        }

        function handleCarry(hasCarry) {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            
            if (hasCarry) {
                var nextColumn = currentColumn + 1;
                carries[nextColumn] = true;
            } else {
                delete carries[currentColumn + 1];
            }
            
            showCarryQuestion = false;
            currentColumn++;
            
            renderOperation();
        }

        function deleteAnswer(idx) {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) return;
            
            delete userAnswer[idx];
            delete carries[idx + 1];
            currentColumn = idx;
            showCarryQuestion = false;
            isChecked = false; // Permitir al usuario corregir después de un chequeo fallido
            document.getElementById('feedback').classList.remove('visible');
            renderOperation();
        }

        function checkAnswer() {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            var numDigits = Math.max(minuend.length, subtrahend.length);
            var correctAnswerNum = parseInt(minuend) - parseInt(subtrahend);
            var correctAnswer = correctAnswerNum.toString().padStart(numDigits, '0');
            
            // CORRECCIÓN: Reconstruir la respuesta del usuario correctamente
            var userResult = '';
            for (let i = 0; i < numDigits; i++) {
                var columnIdx = numDigits - 1 - i; // Convertir de posición de visualización a índice de columna
                if (userAnswer[columnIdx] === undefined) {
                    document.getElementById('feedback').textContent = 'Asegúrate de completar todos los dígitos antes de comprobar.';
                    document.getElementById('feedback').className = 'feedback error visible';
                    isChecked = false;
                    updateUI();
                    return;
                }
                userResult += userAnswer[columnIdx];
            }
            
            userResult = userResult.padStart(numDigits, '0'); 
            
            var feedback = document.getElementById('feedback');

            if (userResult === correctAnswer) {
                feedback.textContent = '¡Excelente! La respuesta es correcta. 🎉';
                feedback.className = 'feedback success visible';
                reproducirSonidoCorrecto();
            } else {
                var displayCorrectAnswer = correctAnswerNum.toString();
                feedback.innerHTML = `Ups, revisa tu respuesta. La respuesta correcta es: <strong>${displayCorrectAnswer}</strong>.`;
                feedback.className = 'feedback error visible';
                reproducirSonidoError();
            }
            
            isChecked = true;
            renderOperation(); 
            updateUI();
        }

        function reset() {
            userAnswer = {};
            carries = {};
            currentColumn = 0;
            showCarryQuestion = false;
            gameStarted = false;
            isChecked = false;
            document.getElementById('feedback').classList.remove('visible');
            renderOperation();
        }

        function changeOperation() {
            initAudio(); // Inicializar audio en el primer clic
            reproducirSonidoTap();
            
            if (isChecked) {
                alert("Por favor, termina o reinicia la operación actual antes de cambiarla.");
                return;
            }
            
            var newMinuend = prompt('Introduce el minuendo (número mayor):', minuend);
            if (newMinuend === null) return; // Usuario canceló
            
            var newSubtrahend = prompt('Introduce el sustraendo (número menor):', subtrahend);
            if (newSubtrahend === null) return; // Usuario canceló
            
            // Validar que sean números y que el minuendo sea mayor
            var numMinuend = parseInt(newMinuend);
            var numSubtrahend = parseInt(newSubtrahend);

            if (isNaN(numMinuend) || isNaN(numSubtrahend)) {
                alert('Error: Ambos valores deben ser números válidos.');
                return;
            }

            if (numMinuend <= numSubtrahend) {
                alert('Error: El minuendo debe ser mayor que el sustraendo.');
                return;
            }
            
            // Si todo es válido, actualizar la operación
            minuend = newMinuend;
            subtrahend = newSubtrahend;
            
            // Actualizar el máximo de dígitos según la operación más larga
            maxDigits = Math.max(minuend.length, subtrahend.length);
            
            reset();
        }

        function updateUI() {
            var numDigits = Math.max(minuend.length, subtrahend.length);
            var questionBox = document.getElementById('questionBox');
            var numberBank = document.getElementById('numberBank');
            var actionButtons = document.getElementById('actionButtons');
            var checkButton = document.getElementById('checkButton');
            var nextButton = document.getElementById('nextButton');
            
            if (showCarryQuestion && !isChecked) {
                questionBox.classList.add('visible');
            } else {
                questionBox.classList.remove('visible');
            }
            
            if (!showCarryQuestion && currentColumn < numDigits && !isChecked) {
                numberBank.classList.add('visible');
            } else {
                numberBank.classList.remove('visible');
            }
            
            if (currentColumn >= numDigits && !showCarryQuestion) {
                actionButtons.classList.add('visible');
            } else {
                actionButtons.classList.remove('visible');
            }
            
            // Lógica de botones: solo se muestra "Siguiente" después de comprobar
            if (isChecked) {
                checkButton.style.display = 'none';
                nextButton.style.display = 'flex'; 
            } else {
                checkButton.style.display = 'flex';
                nextButton.style.display = 'none';
            }
        }

        init();
    </script>
</body>
</html>